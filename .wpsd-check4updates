#!/bin/bash

source /usr/local/sbin/.wpsd-common-funcs

local_calc_file="/etc/.WPSD_local_version_calc"
remote_calc_file="/etc/.WPSD_remote_version_calc"

# Validate that both calculated version files exist before proceeding
if [[ ! -s "$local_calc_file" || ! -s "$remote_calc_file" ]]; then
    exit 1
fi

# Determine which version key to use (standard or DVMega-Cast)
hash_key_to_check="WPSD"
if [[ $(isDVmegaCast) == "true" ]]; then
    hash_key_to_check="WPSD_CAST"
fi

# Extract the single hash value from each file
local_hash=$(grep "^${hash_key_to_check}=" "$local_calc_file" | cut -d'=' -f2)
remote_hash=$(grep "^${hash_key_to_check}=" "$remote_calc_file" | cut -d'=' -f2)

# Compare the hashes to see if an update is available
update_available=false
if [[ -n "$remote_hash" && "$remote_hash" != "$local_hash" ]]; then
    update_available=true
fi

# Display the result
if [[ $update_available == true ]]; then
    if [ -t 1 ]; then # running from terminal
        echo "An update is available for your WPSD installation."
    else # running from web
        echo "&nbsp;<a class=\"lookatme\" lookatme-text=\"Update available!\" href=\"/admin/update.php\">Update available!</a>"
    fi
else
    if [ -t 1 ]; then # running from terminal
        echo "Your WPSD installation is up-to-date."
    fi
fi

exit 0
