#!/bin/bash

# common vars
osName=$( /usr/bin/lsb_release -cs )
if [ -f '/etc/WPSD-release' ]; then
    CALL=$( grep "^Callsign = " /etc/WPSD-release | awk -F' = ' '{print $2}' )
else
    CALL=$( grep "^Callsign = " /etc/pistar-release | awk -F' = ' '{print $2}' )
fi
OS_VER=$(grep -oP '(?<=VERSION_ID=")[^"]+' /etc/os-release)
SUPPORTING_FILES_REPO="https://wpsd-swd.w0chp.net/WPSD-SWD/WPSD-Helpers/raw/branch/master/supporting-files"
ssBackendURI="https://wpsd-swd.w0chp.net/WPSD-SWD/WPSD-Helpers/raw/branch/master/bg-tasks/slipstream-tasks-backend"
bgtBackendURI="https://wpsd-swd.w0chp.net/WPSD-SWD/WPSD-Helpers/raw/branch/master/bg-tasks/run-bg-tasks"
hostFileURL="https://hostfiles.w0chp.net"
gitBranch=$(git --work-tree=/var/www/dashboard --git-dir=/var/www/dashboard/.git symbolic-ref --short HEAD)
dashVer=$( git --work-tree=/var/www/dashboard --git-dir=/var/www/dashboard/.git rev-parse --short=10 ${gitBranch} )
uuidStr=$(egrep 'UUID' /etc/WPSD-release | awk {'print $3'})
uaStrSF="WPSD-SuppFiles"
armbian_env_file="/boot/armbianEnv.txt"
rc_local_file="/etc/rc.local"
OptIntoDiags_value=$(grep -Po "OptIntoDiags = \K.*" /etc/WPSD-Dashboard-Config.ini)
DISPLAY_VALUE=$(grep 'Display=' /etc/mmdvmhost | cut -d'=' -f2)

# Pretty term stuffs ;-)
if [ -t 1 ] || [ -n "$PS1" ] || [ -n "$FORCE_COLOR" ] ; then # terminal and bash call only...
    COL_NC='\e[0m' # No Color
    BOLD='\e[1m'
    REVERSE='\e[7m'
    COL_BLACK='\e[38;5;0m'
    COL_RED='\e[38;5;1m'
    COL_GREEN='\e[38;5;2m'
    COL_YELLOW='\e[38;5;3m'
    COL_BLUE='\e[38;5;4m'
    COL_MAGENTA='\e[38;5;5m'
    COL_CYAN='\e[38;5;6m'
    COL_WHITE='\e[38;5;7m'
    COL_BRIGHT_BLACK='\e[38;5;8m'
    COL_BRIGHT_RED='\e[38;5;9m'
    COL_BRIGHT_GREEN='\e[38;5;10m'
    COL_BRIGHT_YELLOW='\e[38;5;11m'
    COL_BRIGHT_BLUE='\e[38;5;12m'
    COL_BRIGHT_MAGENTA='\e[38;5;13m'
    COL_BRIGHT_CYAN='\e[38;5;14m'
    COL_BRIGHT_WHITE='\e[38;5;15m'
    COL_CUBE_R0_G0_B0='[38;5;16m'
    COL_CUBE_R0_G0_B1='[38;5;17m'
    COL_CUBE_R0_G0_B2='[38;5;18m'
    COL_CUBE_R0_G0_B3='[38;5;19m'
    COL_CUBE_R0_G0_B4='[38;5;20m'
    COL_CUBE_R0_G0_B5='[38;5;21m'
    COL_CUBE_R0_G1_B0='[38;5;22m'
    COL_CUBE_R0_G1_B1='[38;5;23m'
    COL_CUBE_R0_G1_B2='[38;5;24m'
    COL_CUBE_R0_G1_B3='[38;5;25m'
    COL_CUBE_R0_G1_B4='[38;5;26m'
    COL_CUBE_R0_G1_B5='[38;5;27m'
    COL_CUBE_R0_G2_B0='[38;5;28m'
    COL_CUBE_R0_G2_B1='[38;5;29m'
    COL_CUBE_R0_G2_B2='[38;5;30m'
    COL_CUBE_R0_G2_B3='[38;5;31m'
    COL_CUBE_R0_G2_B4='[38;5;32m'
    COL_CUBE_R0_G2_B5='[38;5;33m'
    COL_CUBE_R0_G3_B0='[38;5;34m'
    COL_CUBE_R0_G3_B1='[38;5;35m'
    COL_CUBE_R0_G3_B2='[38;5;36m'
    COL_CUBE_R0_G3_B3='[38;5;37m'
    COL_CUBE_R0_G3_B4='[38;5;38m'
    COL_CUBE_R0_G3_B5='[38;5;39m'
    COL_CUBE_R0_G4_B0='[38;5;40m'
    COL_CUBE_R0_G4_B1='[38;5;41m'
    COL_CUBE_R0_G4_B2='[38;5;42m'
    COL_CUBE_R0_G4_B3='[38;5;43m'
    COL_CUBE_R0_G4_B4='[38;5;44m'
    COL_CUBE_R0_G4_B5='[38;5;45m'
    COL_CUBE_R0_G5_B0='[38;5;46m'
    COL_CUBE_R0_G5_B1='[38;5;47m'
    COL_CUBE_R0_G5_B2='[38;5;48m'
    COL_CUBE_R0_G5_B3='[38;5;49m'
    COL_CUBE_R0_G5_B4='[38;5;50m'
    COL_CUBE_R0_G5_B5='[38;5;51m'
    COL_CUBE_R1_G0_B0='[38;5;52m'
    COL_CUBE_R1_G0_B1='[38;5;53m'
    COL_CUBE_R1_G0_B2='[38;5;54m'
    COL_CUBE_R1_G0_B3='[38;5;55m'
    COL_CUBE_R1_G0_B4='[38;5;56m'
    COL_CUBE_R1_G0_B5='[38;5;57m'
    COL_CUBE_R1_G1_B0='[38;5;58m'
    COL_CUBE_R1_G1_B1='[38;5;59m'
    COL_CUBE_R1_G1_B2='[38;5;60m'
    COL_CUBE_R1_G1_B3='[38;5;61m'
    COL_CUBE_R1_G1_B4='[38;5;62m'
    COL_CUBE_R1_G1_B5='[38;5;63m'
    COL_CUBE_R1_G2_B0='[38;5;64m'
    COL_CUBE_R1_G2_B1='[38;5;65m'
    COL_CUBE_R1_G2_B2='[38;5;66m'
    COL_CUBE_R1_G2_B3='[38;5;67m'
    COL_CUBE_R1_G2_B4='[38;5;68m'
    COL_CUBE_R1_G2_B5='[38;5;69m'
    COL_CUBE_R1_G3_B0='[38;5;70m'
    COL_CUBE_R1_G3_B1='[38;5;71m'
    COL_CUBE_R1_G3_B2='[38;5;72m'
    COL_CUBE_R1_G3_B3='[38;5;73m'
    COL_CUBE_R1_G3_B4='[38;5;74m'
    COL_CUBE_R1_G3_B5='[38;5;75m'
    COL_CUBE_R1_G4_B0='[38;5;76m'
    COL_CUBE_R1_G4_B1='[38;5;77m'
    COL_CUBE_R1_G4_B2='[38;5;78m'
    COL_CUBE_R1_G4_B3='[38;5;79m'
    COL_CUBE_R1_G4_B4='[38;5;80m'
    COL_CUBE_R1_G4_B5='[38;5;81m'
    COL_CUBE_R1_G5_B0='[38;5;82m'
    COL_CUBE_R1_G5_B1='[38;5;83m'
    COL_CUBE_R1_G5_B2='[38;5;84m'
    COL_CUBE_R1_G5_B3='[38;5;85m'
    COL_CUBE_R1_G5_B4='[38;5;86m'
    COL_CUBE_R1_G5_B5='[38;5;87m'
    COL_CUBE_R2_G0_B0='[38;5;88m'
    COL_CUBE_R2_G0_B1='[38;5;89m'
    COL_CUBE_R2_G0_B2='[38;5;90m'
    COL_CUBE_R2_G0_B3='[38;5;91m'
    COL_CUBE_R2_G0_B4='[38;5;92m'
    COL_CUBE_R2_G0_B5='[38;5;93m'
    COL_CUBE_R2_G1_B0='[38;5;94m'
    COL_CUBE_R2_G1_B1='[38;5;95m'
    COL_CUBE_R2_G1_B2='[38;5;96m'
    COL_CUBE_R2_G1_B3='[38;5;97m'
    COL_CUBE_R2_G1_B4='[38;5;98m'
    COL_CUBE_R2_G1_B5='[38;5;99m'
    COL_CUBE_R2_G2_B0='[38;5;100m'
    COL_CUBE_R2_G2_B1='[38;5;101m'
    COL_CUBE_R2_G2_B2='[38;5;102m'
    COL_CUBE_R2_G2_B3='[38;5;103m'
    COL_CUBE_R2_G2_B4='[38;5;104m'
    COL_CUBE_R2_G2_B5='[38;5;105m'
    COL_CUBE_R2_G3_B0='[38;5;106m'
    COL_CUBE_R2_G3_B1='[38;5;107m'
    COL_CUBE_R2_G3_B2='[38;5;108m'
    COL_CUBE_R2_G3_B3='[38;5;109m'
    COL_CUBE_R2_G3_B4='[38;5;110m'
    COL_CUBE_R2_G3_B5='[38;5;111m'
    COL_CUBE_R2_G4_B0='[38;5;112m'
    COL_CUBE_R2_G4_B1='[38;5;113m'
    COL_CUBE_R2_G4_B2='[38;5;114m'
    COL_CUBE_R2_G4_B3='[38;5;115m'
    COL_CUBE_R2_G4_B4='[38;5;116m'
    COL_CUBE_R2_G4_B5='[38;5;117m'
    COL_CUBE_R2_G5_B0='[38;5;118m'
    COL_CUBE_R2_G5_B1='[38;5;119m'
    COL_CUBE_R2_G5_B2='[38;5;120m'
    COL_CUBE_R2_G5_B3='[38;5;121m'
    COL_CUBE_R2_G5_B4='[38;5;122m'
    COL_CUBE_R2_G5_B5='[38;5;123m'
    COL_CUBE_R3_G0_B0='[38;5;124m'
    COL_CUBE_R3_G0_B1='[38;5;125m'
    COL_CUBE_R3_G0_B2='[38;5;126m'
    COL_CUBE_R3_G0_B3='[38;5;127m'
    COL_CUBE_R3_G0_B4='[38;5;128m'
    COL_CUBE_R3_G0_B5='[38;5;129m'
    COL_CUBE_R3_G1_B0='[38;5;130m'
    COL_CUBE_R3_G1_B1='[38;5;131m'
    COL_CUBE_R3_G1_B2='[38;5;132m'
    COL_CUBE_R3_G1_B3='[38;5;133m'
    COL_CUBE_R3_G1_B4='[38;5;134m'
    COL_CUBE_R3_G1_B5='[38;5;135m'
    COL_CUBE_R3_G2_B0='[38;5;136m'
    COL_CUBE_R3_G2_B1='[38;5;137m'
    COL_CUBE_R3_G2_B2='[38;5;138m'
    COL_CUBE_R3_G2_B3='[38;5;139m'
    COL_CUBE_R3_G2_B4='[38;5;140m'
    COL_CUBE_R3_G2_B5='[38;5;141m'
    COL_CUBE_R3_G3_B0='[38;5;142m'
    COL_CUBE_R3_G3_B1='[38;5;143m'
    COL_CUBE_R3_G3_B2='[38;5;144m'
    COL_CUBE_R3_G3_B3='[38;5;145m'
    COL_CUBE_R3_G3_B4='[38;5;146m'
    COL_CUBE_R3_G3_B5='[38;5;147m'
    COL_CUBE_R3_G4_B0='[38;5;148m'
    COL_CUBE_R3_G4_B1='[38;5;149m'
    COL_CUBE_R3_G4_B2='[38;5;150m'
    COL_CUBE_R3_G4_B3='[38;5;151m'
    COL_CUBE_R3_G4_B4='[38;5;152m'
    COL_CUBE_R3_G4_B5='[38;5;153m'
    COL_CUBE_R3_G5_B0='[38;5;154m'
    COL_CUBE_R3_G5_B1='[38;5;155m'
    COL_CUBE_R3_G5_B2='[38;5;156m'
    COL_CUBE_R3_G5_B3='[38;5;157m'
    COL_CUBE_R3_G5_B4='[38;5;158m'
    COL_CUBE_R3_G5_B5='[38;5;159m'
    COL_CUBE_R4_G0_B0='[38;5;160m'
    COL_CUBE_R4_G0_B1='[38;5;161m'
    COL_CUBE_R4_G0_B2='[38;5;162m'
    COL_CUBE_R4_G0_B3='[38;5;163m'
    COL_CUBE_R4_G0_B4='[38;5;164m'
    COL_CUBE_R4_G0_B5='[38;5;165m'
    COL_CUBE_R4_G1_B0='[38;5;166m'
    COL_CUBE_R4_G1_B1='[38;5;167m'
    COL_CUBE_R4_G1_B2='[38;5;168m'
    COL_CUBE_R4_G1_B3='[38;5;169m'
    COL_CUBE_R4_G1_B4='[38;5;170m'
    COL_CUBE_R4_G1_B5='[38;5;171m'
    COL_CUBE_R4_G2_B0='[38;5;172m'
    COL_CUBE_R4_G2_B1='[38;5;173m'
    COL_CUBE_R4_G2_B2='[38;5;174m'
    COL_CUBE_R4_G2_B3='[38;5;175m'
    COL_CUBE_R4_G2_B4='[38;5;176m'
    COL_CUBE_R4_G2_B5='[38;5;177m'
    COL_CUBE_R4_G3_B0='[38;5;178m'
    COL_CUBE_R4_G3_B1='[38;5;179m'
    COL_CUBE_R4_G3_B2='[38;5;180m'
    COL_CUBE_R4_G3_B3='[38;5;181m'
    COL_CUBE_R4_G3_B4='[38;5;182m'
    COL_CUBE_R4_G3_B5='[38;5;183m'
    COL_CUBE_R4_G4_B0='[38;5;184m'
    COL_CUBE_R4_G4_B1='[38;5;185m'
    COL_CUBE_R4_G4_B2='[38;5;186m'
    COL_CUBE_R4_G4_B3='[38;5;187m'
    COL_CUBE_R4_G4_B4='[38;5;188m'
    COL_CUBE_R4_G4_B5='[38;5;189m'
    COL_CUBE_R4_G5_B0='[38;5;190m'
    COL_CUBE_R4_G5_B1='[38;5;191m'
    COL_CUBE_R4_G5_B2='[38;5;192m'
    COL_CUBE_R4_G5_B3='[38;5;193m'
    COL_CUBE_R4_G5_B4='[38;5;194m'
    COL_CUBE_R4_G5_B5='[38;5;195m'
    COL_CUBE_R5_G0_B0='[38;5;196m'
    COL_CUBE_R5_G0_B1='[38;5;197m'
    COL_CUBE_R5_G0_B2='[38;5;198m'
    COL_CUBE_R5_G0_B3='[38;5;199m'
    COL_CUBE_R5_G0_B4='[38;5;200m'
    COL_CUBE_R5_G0_B5='[38;5;201m'
    COL_CUBE_R5_G1_B0='[38;5;202m'
    COL_CUBE_R5_G1_B1='[38;5;203m'
    COL_CUBE_R5_G1_B2='[38;5;204m'
    COL_CUBE_R5_G1_B3='[38;5;205m'
    COL_CUBE_R5_G1_B4='[38;5;206m'
    COL_CUBE_R5_G1_B5='[38;5;207m'
    COL_CUBE_R5_G2_B0='[38;5;208m'
    COL_CUBE_R5_G2_B1='[38;5;209m'
    COL_CUBE_R5_G2_B2='[38;5;210m'
    COL_CUBE_R5_G2_B3='[38;5;211m'
    COL_CUBE_R5_G2_B4='[38;5;212m'
    COL_CUBE_R5_G2_B5='[38;5;213m'
    COL_CUBE_R5_G3_B0='[38;5;214m'
    COL_CUBE_R5_G3_B1='[38;5;215m'
    COL_CUBE_R5_G3_B2='[38;5;216m'
    COL_CUBE_R5_G3_B3='[38;5;217m'
    COL_CUBE_R5_G3_B4='[38;5;218m'
    COL_CUBE_R5_G3_B5='[38;5;219m'
    COL_CUBE_R5_G4_B0='[38;5;220m'
    COL_CUBE_R5_G4_B1='[38;5;221m'
    COL_CUBE_R5_G4_B2='[38;5;222m'
    COL_CUBE_R5_G4_B3='[38;5;223m'
    COL_CUBE_R5_G4_B4='[38;5;224m'
    COL_CUBE_R5_G4_B5='[38;5;225m'
    COL_CUBE_R5_G5_B0='[38;5;226m'
    COL_CUBE_R5_G5_B1='[38;5;227m'
    COL_CUBE_R5_G5_B2='[38;5;228m'
    COL_CUBE_R5_G5_B3='[38;5;229m'
    COL_CUBE_R5_G5_B4='[38;5;230m'
    COL_CUBE_R5_G5_B5='[38;5;231m'
    COL_GRAYSCALE_1='[38;5;232m'
    COL_GRAYSCALE_2='[38;5;233m'
    COL_GRAYSCALE_3='[38;5;234m'
    COL_GRAYSCALE_4='[38;5;235m'
    COL_GRAYSCALE_5='[38;5;236m'
    COL_GRAYSCALE_6='[38;5;237m'
    COL_GRAYSCALE_7='[38;5;238m'
    COL_GRAYSCALE_8='[38;5;239m'
    COL_GRAYSCALE_9='[38;5;240m'
    COL_GRAYSCALE_10='[38;5;241m'
    COL_GRAYSCALE_11='[38;5;242m'
    COL_GRAYSCALE_12='[38;5;243m'
    COL_GRAYSCALE_13='[38;5;244m'
    COL_GRAYSCALE_14='[38;5;245m'
    COL_GRAYSCALE_15='[38;5;246m'
    COL_GRAYSCALE_16='[38;5;247m'
    COL_GRAYSCALE_17='[38;5;248m'
    COL_GRAYSCALE_18='[38;5;249m'
    COL_GRAYSCALE_19='[38;5;250m'
    COL_GRAYSCALE_20='[38;5;251m'
    COL_GRAYSCALE_21='[38;5;252m'
    COL_GRAYSCALE_22='[38;5;253m'
    COL_GRAYSCALE_23='[38;5;254m'
    COL_GRAYSCALE_24='[38;5;255m'
    BULL="${BOLD}\u2022${COL_NC}"
    INFO="${BOLD}[i]${COL_NC}"
    QUES="${BOLD}[?]${COL_NC}"
    NOTE="${BOLD}${COL_BRIGHT_YELLOW}[!]${COL_NC}"
    TICK="${BOLD}${COL_BRIGHT_GREEN}[âœ“]${COL_NC}"
    CROSS="${BOLD}${COL_BRIGHT_RED}[âœ—]${COL_NC}"
    DONE="${BOLD}${COL_BRIGHT_GREEN}Done!${COL_NC}"
    COMPL="${BOLD}${COL_BRIGHT_GREEN}Complete!${COL_NC}"
else # for web interfaces
    BULL="*"
    INFO="[i]"
    QUES="[?]"
    NOTE="[!]"
    TICK="[âœ“]"
    CROSS="[âœ—]"
    DONE="Done!"
    COMPL="Complete!"
fi

# progress spinner
SPINNER_PID=
SPINNER_CHARS="â£¾â£½â£»â¢¿â¡¿â£Ÿâ£¯â£·"
spinner() {
    local i=0
    while :; do
        printf "    [${SPINNER_CHARS:$i:1}] Flashing modem - please wait... \r"
        i=$(( (i + 1) % 8 ))
        sleep 0.1
    done
}

isDVmegaCast() { #obvs
  if [ -d "/opt/cast/.git" ]; then
    echo "true"
  else
    echo "false"
  fi
}

# connectivity check & version cacher
conn_check() {
    uAStr_chk="WPSD ConnectivityCheck & Version Cacher v2.2"
    connection_established=false

    remote_version_url="${hostFileURL}/.WPSD_remote_version"
    ini_file="/etc/.WPSD_remote_version"
    temp_file="$(mktemp)"

    if curl --silent --fail --output "$temp_file" -A "${uAStr_chk}" "$remote_version_url"; then
        connection_established=true
        mv "$temp_file" "$ini_file"
        chmod 644 "$ini_file"
    else
        rm -f "$temp_file"
    fi
}

# Function to check if any network interface has an IP address
interface_has_ip() {
  local interfaces=($(ip -o addr show | awk '{print $2}'))

  for interface in "${interfaces[@]}"; do
    if [[ $interface != "lo" ]]; then
      if ip addr show dev $interface | grep -q 'inet '; then
        return 0
      fi
    fi
  done

  return 1
}

# function to return routable IP:
interface_get_ip() {
  local interfaces=($(ip -o addr show | awk '{print $2}'))

  for interface in "${interfaces[@]}"; do
    if [[ $interface != "lo" ]]; then
      local ip_address=$(ip addr show dev $interface | awk '/inet / {print $2}' | cut -d'/' -f1)
      if [ -n "$ip_address" ]; then
        echo $ip_address
        return 0
      fi
    fi
  done

  return 1
}

# clean up the MMDVM log when modes are paused mid-TX. This eliminaes the
# "infinite TX status" when the radio really isn't TXing.
function process_log_file() {
  current_date=$(date -u "+%Y-%m-%d")
  file_name="/var/log/pi-star/MMDVM-${current_date}.log"

  if [ -e "$file_name" ]; then
    # Find the last line with "received network end of" in the file
    last_line_end_of=$(grep -n "received network end of" "$file_name" | tail -n 1 | cut -d: -f1)

    # If "received network end of" is found, delete lines with "received network voice header" or "received network data from" after that line
    if [ -n "$last_line_end_of" ]; then
      sed -i "${last_line_end_of},\$ {/received network voice header\|received network data from\|received network header from\|received RF end of/d;}" "$file_name"
    fi
  else
    :
  fi
}

function purge_log_files() { #obvs
    wpsd-services fullstop > /dev/null 2>&1
    rm -rf /var/log/pi-star/* > /dev/null 2>&1
    wpsd-services start > /dev/null 2>&1
}

# check if user already has firewall disabled, and if so, ensure it's kept that way.
if grep -q LOGNDROP /etc/iptables.rules; then
    fwState="enabled"
else
    fwState="disabled"
fi

